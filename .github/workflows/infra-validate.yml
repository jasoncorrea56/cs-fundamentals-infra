name: Infra Terraform Validation

on:
  push:
    paths:
      - 'infra/**'
      - 'modules/**'
      - 'docs/**'
      - '.github/workflows/infra-validate.yml'

permissions:
  contents: read

jobs:
  terraform-validate:
    name: Terraform fmt / validate / tfsec
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: Terraform fmt (check only)
        working-directory: infra
        run: terraform fmt -check -recursive

      - name: Terraform init & validate
        run: |
          set -euo pipefail

          roots=(
            "infra/bootstrap"
            "infra/envs/shared/aws"
            "infra/envs/dev/aws"
            "infra/envs/dev/k8s"
            "infra/envs/qa/aws"
            "infra/envs/qa/k8s"
            "infra/envs/prod/aws"
            "infra/envs/prod/k8s"
          )

          for d in "${roots[@]}"; do
            echo "::group::Validating $d"
            cd "$GITHUB_WORKSPACE/$d"
            terraform init -backend=false -input=false -no-color
            terraform validate -no-color
            echo "::endgroup::"
          done

      - name: tfsec (Terraform security scan)
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infra
