name: Infra Terraform Validation

on:
  push:
    paths:
      - 'infra/**'
      - 'modules/**'
      - 'docs/**'
      - '.github/workflows/infra-validate.yml'
  pull_request:
    paths:
      - 'infra/**'
      - 'modules/**'
      - 'docs/**'
      - '.github/workflows/infra-validate.yml'

permissions:
  contents: read

jobs:
  terraform-validate:
    name: Terraform fmt / validate / tfsec
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: Terraform fmt (check only)
        working-directory: infra
        run: terraform fmt -check -recursive

      - name: Find Terraform roots
        id: tf-dirs
        run: |
          set -euo pipefail
          # Find directories under infra/ that contain primary terraform entry files
          dirs=$(find infra -type f \
            \( -name 'main.tf' -o -name 'versions.tf' -o -name 'providers.tf' \) \
            -printf '%h\n' | sort -u)

          if [ -z "$dirs" ]; then
            echo "No terraform directories found under infra/"
            echo "dirs=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Validating the following directories:"
          echo "$dirs"

          {
            echo "dirs<<EOF"
            printf '%s\n' "$dirs"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Terraform init & validate
        if: steps.tf-dirs.outputs.dirs != ''
        run: |
          set -euo pipefail

          while IFS= read -r d; do
            [ -z "$d" ] && continue
            echo "::group::Validating $d"
            cd "$GITHUB_WORKSPACE/$d"
            terraform init -backend=false -input=false -no-color
            terraform validate -no-color
            echo "::endgroup::"
          done <<< "${{ steps.tf-dirs.outputs.dirs }}"

      - name: tfsec (Terraform security scan)
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infra
